---
title: "OLD_Analyses"
author: "Erika Carlson"
date: "2024-09-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

# OLD2-3-5: 2-day binge in F344/BN old (25 mo) and adult (4 mo) rats
### Collaboration between Drs. Kim Nixon and Laura Fonken
**2022-10-24** - **End Date**

------

This document contains research notes and code generated by:

> **Erika R. Carlson**  
> Pharmacology & Toxicology PhD Student  
> University of Texas at Austin  
> erika.carlson@utexas.edu

With assistance from:

> **K. Ryan Thompson**  
> Pharmacology & Toxicology PhD Student  
> University of Texas at Austin  
> kt25399@utexas.edu

------

# Overview

We examined the role of aging on alcohol-induced neuroimmune reactivity in a rat model of an AUD.

Iba1 (ionized calcium binding adapter 1) is a marker of microglia/macrophages.
MHCII (major histone compatability complex II) is a marker of antigen presenting cells.
CD68 (cluser of differentiation 68) is a marker of phagocytosis and lysosomes.

Adult (~4 mo) or aged (~24 mo) male sprague-dawley rats received ethanol (0-5 g/kg, intragastric (i.g.), every 8 h) in a 2-day Majchrowicz paradigm. Tissue was collected as several timepoints post-last dose of ethanol: T0 (intoxication; 3-6 h post-EtOH), T2 (acute abstinence), T7, T14, T28 (prolonged abstinence).
Blood ethanol concentration (BEC; mg/dL) was determined from tail blood collected 90 min post-dose 6.
Tissue was prepared by phosphate-buffered saline perfusion, brain extraction and bisection, and 24 h post-fix in 4% PFA at 4Â°C.

T14 rats were also subjected to a behavioral task (fear conditioning) at T7.



# Preliminaries

```{r Load libraries, message = FALSE, warning = FALSE}
library(tidyverse) # for data wrangling
library(rstatix) # for statistical analysis
library(emmeans) # for statistical analysis
library(afex) # dependency for ANOVA analysis

# Indicate path to save results
results_path <- "data/results/"
```



# Binge statistics

```{r Load and process intoxication scores}
# Load behavioral intoxication score data
intox <- read_csv("data/intoxication.csv", col_names = TRUE)

# Check data
slice_sample(intox, n = 6)

# Add unique subject id
intox$id <- paste(intox$subject, intox$cohort, sep = "-")

# Remove subjects that did not survive or excluded for BEC > 500 mg/dl
intox <- intox %>% filter(exclude == "N") 

# Calculate average behavioral intoxication score per subject
intox <- intox %>% 
  mutate(mean = rowMeans(select(., dose_01, dose_02, dose_03, dose_04, dose_05, dose_06)))

# Get summary statistics
intox_summary <- intox %>%
  group_by(age, timepoint) %>%
  get_summary_stats(mean, type = "mean_se") %>%
  as_tibble() %>%
  write_csv(., str_c(results_path, "intoxication_summary.csv"))
intox_summary


# Compute two-way ANOVA on average behavioral intoxication, unbalanced design, type III
intox_aov2 <- aov_ez(id = 'id', 
                   dv = 'mean', 
                   data = intox, 
                   between = c('age', 'timepoint'))

(anova(intox_aov2)) %>%
  rownames_to_column(var = "Factor") %>%
  as_tibble() %>% 
  write_csv(., str_c(results_path, "intoxication_aov2.csv"))
# no main effects nor interactions

# Compute estimated marginal means for two-way ANOVA
intox_aov2_emm <- emmeans(intox_aov2, 
                           ~ age * timepoint,
                           adjust = "sidak")

# Compare age for each timepoint -- "simple effects"
intox_aov2_age_post <- pairs(intox_aov2_emm, simple = "age") %>% 
  as_tibble() %>%
  write_csv(., str_c(results_path, "intoxication_aov2_age_posthoc.csv"))

# Compare timepoint for each age -- "simple effects"
intox_aov2_time_post <- pairs(intox_aov2_emm, simple = "timepoint") %>% 
  as_tibble() %>%
  write_csv(., str_c(results_path, "intoxication_aov2_time_posthoc.csv"))
```


```{r Load and process ethanol dose}
# Load ethanol dose data
dose <- read_csv("data/dose.csv")

# Check data
slice_sample(dose, n = 6)

# Add unique subject id
dose$id <- paste(dose$subject, dose$cohort, sep = "-")

# Remove subjects that did not survive or excluded for BEC > 500 mg/dl
dose <- dose %>% filter(exclude == "N") 

# Calculate average dose per day per subject
dose <- dose %>% 
  mutate(day_01 = rowSums(select(., dose_01, dose_02, dose_03)),
         day_02 = rowSums(select(., dose_04, dose_05, dose_06)))

dose <- dose %>% mutate(day_mean = rowMeans(select(., day_01, day_02)))

# Get summary statistics
dose_summary <- dose %>%
  group_by(age, timepoint) %>%
  get_summary_stats(day_mean, type = "mean_se") %>% 
  as_tibble() %>% 
  write_csv(., str_c(results_path, "dose_summary.csv"))
dose_summary


# Compute two-way ANOVA on average dose, unbalanced design, type III
dose_aov2 <- aov_ez(id = 'id', 
                    dv = 'day_mean', 
                    data = dose, 
                    between = c('age', 'timepoint'))

(anova(dose_aov2)) %>%
  rownames_to_column(var = "Factor") %>%
  as_tibble() %>% 
  write_csv(., str_c(results_path, "dose_aov2.csv"))
# no main effects (timepoint p = 0.07)

# Compute estimated marginal means for two-way ANOVA
dose_aov2_emm <- emmeans(dose_aov2, 
                         ~ age * timepoint,
                         adjust = "sidak")

# Compare age for each timepoint -- "simple effects"
dose_aov2_age_post <- pairs(dose_aov2_emm, simple = "age") %>% 
  as_tibble() %>%
  write_csv(., str_c(results_path, "dose_aov2_age_posthoc.csv"))

# Compare timepoint for each age -- "simple effects"
dose_aov2_time_post <- pairs(dose_aov2_emm, simple = "timepoint") %>% 
  as_tibble() %>%
  write_csv(., str_c(results_path, "dose_aov2_time_posthoc.csv"))
```


# *Update with OLD5 becs*

```{r Load and process blood ethanol concentrations}
# Load bec data
bec <- read_csv("data/BEC.csv")

# Check data
slice_sample(bec, n = 6)

# Add unique subject id
bec$id <- paste(bec$subject, bec$cohort, sep = "-")

# Remove subjects that did not survive or excluded for BEC > 500 mg/dl
bec <- bec %>% filter(exclude == "N") 

# Get summary statistics
bec_summary <- bec %>%
  group_by(age, timepoint) %>%
  get_summary_stats(mean, type = "mean_se") %>% 
  as_tibble() %>% 
  write_csv(., str_c(results_path, "/bec_summary.csv"))
bec_summary

# Compute two-way ANOVA on bec, unbalanced design, type III
bec_aov2 <- aov_ez(id = 'id', 
                    dv = 'day_mean', 
                    data = bec, 
                    between = c('age', 'timepoint'))

(anova(bec_aov2)) %>%
  rownames_to_column(var = "Factor") %>%
  as_tibble() %>% 
  write_csv(., str_c(results_path, "bec_aov2.csv"))
# 

# Compute estimated marginal means for two-way ANOVA
bec_aov2_emm <- emmeans(bec_aov2, 
                         ~ age * timepoint,
                         adjust = "sidak")

# Compare age for each timepoint -- "simple effects"
bec_aov2_age_post <- pairs(bec_aov2_emm, simple = "age") %>% 
  as_tibble() %>%
  write_csv(., str_c(results_path, "bec_aov2_age_posthoc.csv"))

# Compare timepoint for each age -- "simple effects"
bec_aov2_time_post <- pairs(bec_aov2_emm, simple = "timepoint") %>% 
  as_tibble() %>%
  write_csv(., str_c(results_path, "bec_aov2_time_posthoc.csv"))
```



## 1 Vimentin in MLDG

### Round 1 details

Date of binge: 2022-10-24 (OLD2A); 2022-12-11 (OLD2B)
Date of tissue collection: 
  2022-10-26 (T0, intoxication)
  2022-10-28 (T2, abstinence)
  2022-11-02; 2022-12-20 (T7, abstinence)
Date of staining: 
  2022-12-09 (A; T0, intoxication)
  2023-01-27 (A; T2, abstinence)
  2023-04-13 (A/B; T7, abstinence)
  2023-05-11 (B; T0/T2)
Date of imaging: 
  2022-12-16/18 (A; T0, intoxication)
  2023-01-31 (A; T2, abstinence)
  2023-04-19 (A/B; T7, abstinence)
  2023-05-17 (B; T0/T2)
Location: BX
Magnification: 4X
Numerical Aperture: 
Regions: DGML (dentate gyrus molecular layer)
Image analysis: Densitometry in ImageJ, hand drawn ROIs of MLDG and background
Statistics: Percent Area of MLGD - Percent Area of "background"
Purpose: Determine average percent area of staining per subject
Statistical analysis: two-way ANOVA with age and EtOH
End Result: 

### Round 2 details
Date of binge: 2022-10-24 (OLD2A); 2022-12-11 (OLD2B); (OLD3A); (OLD3B); (OLD5)
Date of tissue collection: 
  2022-10-26 (T0, intoxication)
  2022-10-28 (T2, abstinence)
  2022-11-02; 2022-12-20 (T7, abstinence)
  (T14)
  (T28)
Date of staining: 
  
Date of imaging: 
  

### 1.1 Percent Area of Astrocytic staining
**2024-05-22**

NOTE: update with 2024 imaging

Extract data from .csv file

```{r}
# Load vimentin data
vimentin <- read_csv("data/vimentin.csv")

# Compute background subtraction
vimentin <- vimentin %>% mutate(difference = MLDG - background)

# Calculate summary statistics per subject
vimentin_summary <- vimentin_raw %>% 
  select(difference, subject) %>% 
  group_by(subject) %>% 
  summarize(avg = mean(difference),
            sd = sd(difference),
            slices = n(),
            sem = sd/sqrt(slices))

#set path to treatment label file
meta_path <- "OLD_subjects.csv"

#Read in treatment information and match column types as needed
treatment <- read_csv(meta_path) %>% 
  select(!Notes)

#Bind count data with treatment
csv_percent_bysubject <- left_join(vimentin_summary, treatment) %>% 
  arrange(age, diet, timepoint, as.numeric(subject))

# Export .csv file
write_csv(csv_percent_bysubject, 
        str_c(results_path, "/vimentin.csv"))
```


### 1.2 Statistical analysis of MLDG
**2024-05-22**

```{r}
#run two-way ANOVA with Group and Age (n = 4-7 per group, unbalanced 2x2 design)
#If main effect and interaction, posthoc with Sidak adjust for multi comparisons
#Export .csv file
#install.packages('afex')
#install.packages('emmeans')
library(afex)
library(emmeans)
library(ggplot2)

results_path <- "/Users/erc2866/Library/CloudStorage/Box-Box/Nixon Lab/Lab Member's Data Files/Erika/OLD2/Results/VIM"

csv_percent_bysubject <- read_csv(str_c(results_path, 
                                        "/Results_VIM_PercentArea_bysubject.csv"))

#check n per group of data
table(csv_percent_bysubject$Group, csv_percent_bysubject$Age)

#visualize data simply
ggplot(csv_percent_bysubject, 
       aes(x=Age, y=VIM_avg, 
           fill=Group)) + 
  geom_boxplot() +
  scale_fill_brewer()

# review outliers
out <- boxplot.stats(csv_percent_bysubject$VIM_avg)$out
out_ind <- which(csv_percent_bysubject$VIM_avg %in% c(out))
out_ind
csv_percent_bysubject[out_ind, ]
# subjects 3, 4, 5, 6 considered outliers


#aov2 for colabel, two-way ANOVA for unbalanced design, type III default
aov2_VIM <- aov_ez(id = 'subject', 
                          dv = 'VIM_avg', 
                          data = csv_percent_bysubject, 
                          between = c('Age', 'Group')
                          )

(anova(aov2_VIM)) %>%
  rownames_to_column(var = "Factor") %>%
  as_tibble() %>% 
  write_csv(., str_c(results_path, "/Results_VIM_percent_aov2.csv"))
#main effect of Group

#parenthesis will print and run output
(post_aov2_VIM <- emmeans(aov2_VIM, 
                                 pairwise ~ Group * Age,
                                 adjust = "sidak")
  $contrasts[c(1,2,3,4,8,9,11,14,17,22,23,24,25,26,27,28)] %>% 
# contrasts[c()] used to restrict comparisons if needed
  as_tibble()) %>%
  write_csv(., str_c(results_path, "/Results_VIM_percent_aov2_posthoc.csv"))
```

## 2 Adding on to Vimentin in MLDG

```{r}
library(tidyverse)

path <- "/Users/erc2866/Library/CloudStorage/Box-Box/Nixon Lab/Lab Member's Data Files/Erika/OLD3/OLD3_MHCII_Iba1_T14/"

# Replicability (change number for each blinding iteration)
set.seed(8)

# Create blind code
# Size in sample function equal to number of subjects to blind
# Sampling without replacement
blind <- c(LETTERS, str_c(LETTERS,LETTERS))
blind_rand <- sample(blind[1:12], size = 12, replace = FALSE)

# read in subject data
subjects <- read_csv(<path_to_csv>, col_names = TRUE)

# add blind code column to subject data
subjects_blind <- subjects %>% mutate(blind_code = blind_rand)

# save blind key
write_csv(subjects_blind, str_c(<path_to_save_location>, <name_of_blind_key_file>.csv))
```




## Archived code

### Debugging

```{r echo = TRUE, results = 'hide'}

```

### Failed strategies

```{r echo = TRUE, results = 'hide'}

```

